# Express & SQL with Postgres: Show & Create

## Getting Started

- Get your express server running
- Make sure Postgres is running
- In the browse,r go to the index route and check that it works

## Show

> **Note**:One thing that will be different with your builds is that instead of using the array position, we will use each item's unique `id` generated by Postgres.

Start by creating the query. Create an async arrow function and be sure to include it in `module.exports`.

```js
// queries/bookmarks.js
// ONE Bookmark
const getBookmark = async () => {};

module.exports = {
  getAllBookmarks,
  getBookmark,
};
```

- Where will we will get the value of the `id` from?

- What should the function `db.one()` return?

- What are the two arguments needed for the function `db.one()`?

- Why must you use the `$` in a plain string to represent variables in the SQL statement? Why can't you simply use JavaScript string interpolation?

```js
const getBookmark = async (id) => {
  try {
    const oneBookmark = await db.one("SELECT * FROM bookmarks WHERE id=$1", id);
    return oneBookmark;
  } catch (error) {
    return error;
  }
};
```

Import the function to your controller:

```js
// controllers/bookmarkController.js
const { getAllBookmarks, getBookmark } = require("../queries/bookmarks");
```

Create the show route and test it in the browser/Postman.

```js
// SHOW
bookmarks.get("/:id", async (req, res) => {
  const { id } = req.params;
  res.json({ id });
});
```

Add in the query and add some error handling:

```js
// SHOW
bookmarks.get("/:id", async (req, res) => {
  const { id } = req.params;
  const bookmark = await getBookmark(id);
  if (bookmark) {
    res.json(bookmark);
  } else {
    res.status(404).json({ error: "not found" });
  }
});
```

## Create

Create an async arrow function and be sure to include it in `module.exports`.

```js
// queries/bookmarks.js
const createBookmark = async (bookmark) => {
  try {
  } catch (error) {
    throw error;
  }
};

module.exports = {
  getAllBookmarks,
  createBookmark,
  getBookmark,
};
```

Inserting into the database requires two arguments.

- Should you use `db.one()` for this POST request?
- What are the other methods available?
- What library do the `db.` methods come from (Express, dotenv, pg-promise)?
- Where can you go to learn the different methods?

Set up our basic statement:

```js
// CREATE
const createBookmark = async (bookmark) => {
  try {
    const newBookmark = await db.one(
      "INSERT INTO bookmarks (name, url, category, is_favorite) VALUES($1, $2, $3, $4) RETURNING *",
      [bookmark.name, bookmark.url, bookmark.category, bookmark.is_favorite]
    );
    return newBookmark;
  } catch (error) {
    return error;
  }
};
```

- What is the purpose of including `RETURNING *`?

Import the function to the controller:

```js
// controllers/bookmarkController.js
const {
  getAllBookmarks,
  getBookmark,
  createBookmark,
} = require("../queries/bookmarks");
```

Create the show route and test it with Postman.

```js
// CREATE
bookmarks.post("/", async (req, res) => {
  try {
    const bookmark = await createBookmark(req.body);
    res.json(bookmark);
  } catch (error) {
    res.status(400).json({ error: error });
  }
});
```

Example Bookmark:

```js
{
 "name":"AV Club",
 "url": "https://www.avclub.com",
 "is_favorite": "false"
}
```

## Error Handling/Validating input

Our users can make a bunch of mistakes.

Not including a name:

```js
{
 "url": "https://www.avclub.com",
 "is_favorite": "false"
}
```

If we put this request through Postman, We get a hard-to-read error.

- Why do we get an error for the `name` field being blank, but we can exclude `is_favorite` and not get an error?

- Why is error handling important?
- Why do you want to separate the functionality for checking for valid inputs from the route?

Set up a separate folder and file for validations:

- `mkdir validations`
- `touch validations/checkBookmarks.js`

```js
// validations/checkBookmarks.js
const checkName = (req, res, next) => {
  console.log("checking name...");
};

module.exports = { checkName };
```

Import the function to the controller:

```js
// controller/bookmarksController.js
const { checkName } = require("../validations/checkBookmarks.js");
```

Add this function as middleware for the create route.

```js
// CREATE
bookmarks.post("/", checkName, async (req, res) => {
```

Write some logic to check the name:

```js
const checkName = (req, res, next) => {
  if (req.body.name) {
    console.log("name is ok");
  } else {
    res.status(400).json({ error: "Name is required" });
  }
};
```

- Why are you not getting a response if the name is truthy?
- How can you get to the POST route from this function?

```js
const checkName = (req, res, next) => {
  if (req.body.name) {
    console.log("name is ok");
    return next();
  } else {
    res.status(400).json({ error: "Name is required" });
  }
};
```

Try again with Postman:

Error:

```js
{
 "url": "https://www.avclub.com",
 "is_favorite": "false"
}
```

OK:

```js
{
 "name": "Apple",
 "url": "https://www.apple.com",
 "is_favorite": "true"
}
```

#### Another User Error

We can end up where the user/front-end app does not give a Boolean value.

```js
{
 "name":"Ikea",
 "url": "https://www.ikea.com",
 "is_favorite": "Maybe"
}
```

- Why will Postgres not accept the value `maybe` for the `is_favorite` field?

Create a validation to be sure the value is a boolean.

```js
// validations/checkBookmarks/js
const checkBoolean = (req, res, next) => {
  if (req.body.is_favorite) {
    next();
  } else {
    res.status(400).json({ error: "is_favorite must be a boolean value" });
  }
};

module.exports = { checkBoolean, checkName };
```

Don't forget to add this to the `bookmarkController.js`.

```js
const { checkBoolean, checkName } = require("../validations/checkBookmarks.js");


// Further down
bookmarks.post("/", checkBoolean, checkName, async (req, res) => {
```

It doesn't work as expected. The possible valid values are:

- `true`
- `"true"`
- `false`
- `"false"`
- `undefined`

How can we check if the `req.body.is_favorite` value is a valid value?

## Save it

- `git add -A`
- `git commit -m 'show and create complete'`.

## Reference

[See the build here](https://github.com/pursuit-curriculum-resources/express-sql-seed-read-demo/tree/show-create)
