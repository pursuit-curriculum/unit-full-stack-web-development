# Express & SQL Update & Delete

## Adding a Database to our Express App

## Rebuild Bookmarks

## Getting Started

- Get your express server running
- Make sure Postgres is running
- In the browser, go to the index route and check that it works

## Reminder

**IMPORTANT:** One thing that will be different with your builds is that instead of using the array position, we will use each item's unique `id` generated by Postgres.

For example, looking at the data, we inserted `Apartment Therapy` should have an `id` of `2`.

![](../assets/id-not-array-index.png)

If we were to access it by array position, it would be at array position `1`. We did this earlier for simplicity. However, there is never a guarantee that an item will be in a specific order/array position, and it can change. So using the `id` is critical now that we have a database.

## Delete

Start by creating the query. Create an async arrow function and be sure to include it in `module.exports`. Work from the outside in by creating the try/catch blocks first.

```js
// queries/bookmarks.js
const deleteBookmark = async (id) => {
  try {
  } catch (error) {
    return error;
  }
};

module.exports = {
  getAllBookmarks,
  getBookmark,
  createBookmark,
  deleteBookmark,
};
```

Add the functionality.

```js
const deleteBookmark = async (id) => {
  try {
    const deletedBookmark = await db.one(
      "DELETE FROM bookmarks WHERE id = $1 RETURNING *",
      id
    );
    return deletedBookmark;
  } catch (error) {
    return error;
  }
};
```

Import the function to the controller.

```js
// controllers/bookmarkController.js
const {
  getAllBookmarks,
  getBookmark,
  createBookmark,
  deleteBookmark,
} = require("../queries/bookmarks");
```

Create just the delete route and test it with Postman.

```js
// DELETE
bookmarks.delete("/:id", async (req, res) => {
  const { id } = req.params;
  res.status(200).json({ id });
});
```

Now add the database call:

```js
// DELETE
bookmarks.delete("/:id", async (req, res) => {
  const { id } = req.params;
  const deletedBookmark = await deleteBookmark(id);
  res.status(200).json(deletedBookmark);
});
```

Add some error handling.

```js
bookmarks.delete("/:id", async (req, res) => {
  const { id } = req.params;
  const deletedBookmark = await deleteBookmark(id);
  if (deletedBookmark.id) {
    res.status(200).json(deletedBookmark);
  } else {
    res.status(404).json("Bookmark not found");
  }
});
```

Test it with Postman.

## Update

Start by creating the query. Create an async arrow function and be sure to include it in `module.exports`

```js
// queries/bookmarks.js
const updateBookmark = async (id, bookmark) => {
  try {
  } catch (error) {
    return error;
  }
};

module.exports = {
  getAllBookmarks,
  getBookmark,
  createBookmark,
  deleteBookmark,
  updateBookmark,
};
```

Add the query:

```js
const updateBookmark = async (id, bookmark) => {
  try {
    const updatedBookmark = await db.one(
      "UPDATE bookmarks SET name=$1, url=$2, category=$3, is_favorite=$4 where id=$5 RETURNING *",
      [bookmark.name, bookmark.url, bookmark.category, bookmark.is_favorite, id]
    );
    return updatedBookmark;
  } catch (error) {
    return error;
  }
};
```

Import the function.

```js
// controllers/bookmarkController.js
const {
  getAllBookmarks,
  getBookmark,
  createBookmark,
  deleteBookmark,
  updateBookmark,
} = require("../queries/bookmarks");
```

Create just the route and test it.

```js
// UPDATE
bookmarks.put("/:id", async (req, res) => {
  const { id } = req.params;
  res.status(200).json({ id });
});
```

Now add the database call.

```js
// UPDATE
bookmarks.put("/:id", async (req, res) => {
  const { id } = req.params;
  const updatedBookmark = await updateBookmark(id, req.body);
  res.status(200).json(updatedBookmark);
});
```

Test it and remember to have the following:

- route PUT /bookmarks/:id

```js
{
 "name":"Weather",
 "url": "https://darksky.net/",
 "is_favorite": "true"
}
```

Remember, the same rules apply that applied to create. There must be a name, and `is_favorite` must be a boolean (or undefined - why is undefined an ok option?).

We can easily update our function to do those checks because we created the functionality separate from the create route.

```js
bookmarks.put("/:id", checkName, checkBoolean, async (req, res) => {
```

## Final Validation

We checked for one more thing the first time we built this app. We checked if the URL provided starts with `http` or `https`.

```js
// validations/checkBookmarks.js
const validateURL = (req, res, next) => {
  if (
    req.body.url.substring(0, 7) === "http://" ||
    req.body.url.substring(0, 8) === "https://"
  ) {
    return next();
  } else {
    res
      .status(400)
      .json({ error: `You forgot to start your url with http:// or https://` });
  }
};
```

Please take a few minutes to add this validation as middleware to the create and update routes, and be sure to test it.

**Thought Question**: Do you need to put these validations in Index, Show or Delete? Why or why not?

## Save it

- `git add -A`
- `git commit -m 'update and delete complete'`.

## Reference

[Reference build](https://github.com/pursuit-curriculum-resources/express-sql-seed-read-demo/tree/update-delete)
